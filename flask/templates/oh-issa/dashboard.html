{% extends "oh-issa/template-ohissa.html" %}

{% block title %}Dashboard - OH-ISSA{% endblock %}

{% block input_active %}active{% endblock %}

{% block content %}
<h1>Dashboard Amministratore</h1>

<section>
    <h2>Importazione Dati</h2>
    
    <div class="form-group">
        <h3>Docenti</h3>
        <form id="teachersForm" action="/flask/admin/upload-teachers" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="teachersFile">File Docenti (CSV):</label>
                <input type="file" id="teachersFile" name="file" accept=".csv,.tsv,.txt">
            </div>
            <button type="submit" class="btn btn-primary">Carica Docenti</button>
        </form>
    </div>
    
    <div class="form-group" style="margin-top: 2rem;">
        <h3>Insegnamenti</h3>
        <form id="teachingsForm" action="/flask/admin/upload-teachings" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="teachingsFile">File Insegnamenti (CSV):</label>
                <input type="file" id="teachingsFile" name="file" accept=".csv,.tsv,.txt">
            </div>
            <button type="submit" class="btn btn-primary">Carica Insegnamenti</button>
        </form>
    </div>
</section>

<section style="margin-top: 3rem;">
    <h2>Reset Database</h2>
    
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-danger reset-btn" data-table="docenti">Reset Tabella Docenti</button>
        <button class="btn btn-danger reset-btn" data-table="insegnamenti">Reset Tabella Insegnamenti</button>
        <button class="btn btn-danger reset-btn" data-table="esami">Reset Tabella Esami</button>
    </div>
</section>

<div id="responseMessages" style="margin-top: 2rem;"></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestisci il form di upload docenti
        document.getElementById('teachersForm').addEventListener('submit', function(e) {
            e.preventDefault();
            uploadFile(this, 'Docenti');
        });
        
        // Gestisci il form di upload insegnamenti
        document.getElementById('teachingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            uploadFile(this, 'Insegnamenti');
        });
        
        // Gestisci i pulsanti di reset
        document.querySelectorAll('.reset-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const table = this.getAttribute('data-table');
                if (confirm(`Sei sicuro di voler eliminare tutti i dati della tabella ${table}?`)) {
                    resetTable(table);
                }
            });
        });
        
        // Funzione per caricare i file
        function uploadFile(form, type) {
            const formData = new FormData(form);
            const fileInput = form.querySelector('input[type="file"]');
            
            if (!fileInput.files[0]) {
                showMessage('error', `Seleziona un file per caricare i ${type.toLowerCase()}`);
                return;
            }
            
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('success', data.message);
                    form.reset();
                } else {
                    showMessage('error', data.message);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                showMessage('error', `Si è verificato un errore durante l'upload: ${error.message}`);
            });
        }
        
        // Funzione per resettare una tabella
        function resetTable(table) {
            fetch(`/flask/admin/truncate-table/${table}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('success', data.message);
                } else {
                    showMessage('error', data.message);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                showMessage('error', `Si è verificato un errore durante il reset: ${error.message}`);
            });
        }
        
        // Funzione per mostrare messaggi
        function showMessage(type, message) {
            const messageDiv = document.getElementById('responseMessages');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.textContent = message;
            
            messageDiv.appendChild(alert);
            
            // Rimuovi il messaggio dopo 5 secondi
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    });
</script>
{% endblock %}